<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Card Collector Pro</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Exo+2:wght@400;700;900&family=Orbitron:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root {
            --common-color: #b8b8b8;
            --uncommon-color: #4caf50;
            --rare-color: #2196f3;
            --epic-color: #9c27b0;
            --legendary-color: #ffc107;
            --primary: #5D5CDE;
            --primary-dark: #4a49b8;
            --bg-light: #f5f8ff;
            --bg-dark: #181818;
            --text-light: #333;
            --text-dark: #eee;
            --card-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
            --inventory-bg-light: rgba(255, 255, 255, 0.9);
            --inventory-bg-dark: rgba(40, 40, 40, 0.9);
            --market-bg-light: rgba(245, 245, 255, 0.95);
            --market-bg-dark: rgba(30, 30, 40, 0.95);
            --success-color: #4caf50;
            --error-color: #f44336;
            --warning-color: #ff9800;
        }

        body {
            margin: 0;
            padding: 0;
            font-family: 'Exo 2', sans-serif;
            min-height: 100vh;
            background: var(--bg-light);
            color: var(--text-light);
            transition: background-color 0.3s, color 0.3s;
            overflow-x: hidden;
            background-image: url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M11 18c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm48 25c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm-43-7c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm63 31c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM34 90c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm56-76c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM12 86c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm28-65c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm23-11c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-6 60c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm29 22c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zM32 63c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm57-13c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-9-21c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM60 91c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM35 41c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM12 60c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2z' fill='%235d5cde' fill-opacity='0.06' fill-rule='evenodd'/%3E%3C/svg%3E");
        }

        .dark {
            background: var(--bg-dark);
            color: var(--text-dark);
            background-image: url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M11 18c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm48 25c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm-43-7c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm63 31c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM34 90c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm56-76c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM12 86c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm28-65c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm23-11c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-6 60c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm29 22c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zM32 63c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm57-13c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-9-21c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM60 91c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM35 41c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM12 60c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2z' fill='%235d5cde' fill-opacity='0.1' fill-rule='evenodd'/%3E%3C/svg%3E");
        }

        /* Loading Screen */
        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            color: white;
            transition: opacity 0.5s, visibility 0.5s;
        }

        .loading-screen.hidden {
            opacity: 0;
            visibility: hidden;
        }

        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 6px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spinner 1s ease-in-out infinite;
            margin-bottom: 20px;
        }

        .loading-text {
            font-family: 'Orbitron', sans-serif;
            font-size: 1.2rem;
            text-align: center;
        }

        /* Auth Screen */
        .auth-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9000;
            transition: opacity 0.5s, visibility 0.5s;
        }

        .auth-screen.hidden {
            opacity: 0;
            visibility: hidden;
            pointer-events: none;
        }

        .auth-container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 40px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(10px);
            text-align: center;
        }

        .dark .auth-container {
            background: rgba(30, 30, 40, 0.95);
            color: var(--text-dark);
        }

        .auth-title {
            font-family: 'Orbitron', sans-serif;
            font-size: 2rem;
            margin-bottom: 30px;
            color: var(--primary);
        }

        .auth-form {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .auth-input {
            padding: 15px;
            border: 2px solid rgba(93, 92, 222, 0.3);
            border-radius: 10px;
            font-size: 1rem;
            background: rgba(255, 255, 255, 0.8);
            transition: border-color 0.3s;
        }

        .dark .auth-input {
            background: rgba(50, 50, 60, 0.8);
            color: var(--text-dark);
        }

        .auth-input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .auth-button {
            padding: 15px;
            background: linear-gradient(45deg, var(--primary), var(--primary-dark));
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .auth-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(93, 92, 222, 0.4);
        }

        .auth-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .auth-toggle {
            margin-top: 20px;
            color: var(--primary);
            cursor: pointer;
            text-decoration: underline;
        }

        .auth-error {
            color: var(--error-color);
            font-size: 0.9rem;
            margin-top: 10px;
        }

        /* User Profile Section */
        .user-profile {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-right: 20px;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(45deg, var(--primary), var(--primary-dark));
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 1.2rem;
        }

        .user-info {
            display: flex;
            flex-direction: column;
        }

        .user-name {
            font-weight: bold;
            font-size: 0.9rem;
        }

        .user-level {
            font-size: 0.8rem;
            opacity: 0.8;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            border-bottom: 2px solid var(--primary);
            margin-bottom: 20px;
            position: relative;
            flex-wrap: wrap;
            gap: 15px;
        }

        .game-title {
            font-family: 'Orbitron', sans-serif;
            font-size: 2.5rem;
            font-weight: 900;
            color: var(--primary);
            text-shadow: 0 2px 10px rgba(93, 92, 222, 0.3);
            margin: 0;
            background: linear-gradient(45deg, var(--primary), #9082ff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: pulse 3s infinite;
        }

        .header-center {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .currency-display {
            display: flex;
            align-items: center;
            font-family: 'Orbitron', sans-serif;
            font-size: 1.4rem;
            color: var(--primary);
            border: 2px solid var(--primary);
            padding: 8px 16px;
            border-radius: 20px;
            background: rgba(93, 92, 222, 0.1);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .currency-icon {
            margin-right: 10px;
            font-size: 1.6rem;
        }

        .nav-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .button {
            padding: 10px 20px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 30px;
            font-family: 'Exo 2', sans-serif;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 4px 10px rgba(93, 92, 222, 0.3);
            position: relative;
            overflow: hidden;
        }

        .button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(93, 92, 222, 0.4);
        }

        .button:active {
            transform: translateY(1px);
            box-shadow: 0 2px 5px rgba(93, 92, 222, 0.2);
        }

        .button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .button.primary {
            background: linear-gradient(45deg, var(--primary), var(--primary-dark));
            font-size: 1.2rem;
            padding: 12px 25px;
        }

        .button.inventory-btn {
            background: linear-gradient(45deg, #ff9800, #ff5722);
        }

        .button.market-btn {
            background: linear-gradient(45deg, #2196f3, #03a9f4);
        }

        .button.craft-btn {
            background: linear-gradient(45deg, #9c27b0, #673ab7);
        }

        .button.profile-btn {
            background: linear-gradient(45deg, #4caf50, #45a049);
        }

        .button.logout-btn {
            background: linear-gradient(45deg, #f44336, #e91e63);
            padding: 8px 15px;
            font-size: 0.9rem;
        }

        .button.sell-all-btn {
            background: linear-gradient(45deg, #f44336, #e91e63);
        }

        .button.theme-toggle {
            width: 48px;
            height: 48px;
            padding: 0;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(45deg, #333, #666);
        }

        .button.theme-toggle svg {
            width: 24px;
            height: 24px;
        }

        .sync-status {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.8rem;
            padding: 5px 10px;
            border-radius: 15px;
            background: rgba(76, 175, 80, 0.1);
            color: var(--success-color);
            border: 1px solid rgba(76, 175, 80, 0.3);
        }

        .sync-status.syncing {
            background: rgba(255, 152, 0, 0.1);
            color: var(--warning-color);
            border-color: rgba(255, 152, 0, 0.3);
        }

        .sync-status.error {
            background: rgba(244, 67, 54, 0.1);
            color: var(--error-color);
            border-color: rgba(244, 67, 54, 0.3);
        }

        .main-section {
            display: flex;
            gap: 20px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .roll-section {
            flex: 1;
            min-width: 300px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
            padding: 30px;
            border-radius: 20px;
            background: linear-gradient(145deg, rgba(255, 255, 255, 0.1), rgba(255, 255, 255, 0.05));
            backdrop-filter: blur(10px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .dark .roll-section {
            background: linear-gradient(145deg, rgba(30, 30, 40, 0.6), rgba(20, 20, 30, 0.3));
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .roll-area {
            width: 100%;
            height: 300px;
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
            perspective: 1000px;
            overflow: hidden;
            border-radius: 15px;
            background: rgba(0, 0, 0, 0.05);
        }

        .dark .roll-area {
            background: rgba(255, 255, 255, 0.02);
        }

        .card {
            width: 200px;
            height: 280px;
            position: relative;
            transform-style: preserve-3d;
            border-radius: 15px;
            cursor: pointer;
            box-shadow: var(--card-shadow);
            transition: transform 0.6s cubic-bezier(0.23, 1, 0.32, 1);
            background-color: white;
            overflow: hidden;
        }

        .card.flipping {
            animation: flip 1s ease-out forwards;
        }

        .card.rolling {
            animation: roll 1.5s ease-out forwards;
        }

        .card-face {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            border-radius: 15px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            box-sizing: border-box;
            border: 5px solid #fff;
            background-size: cover;
            background-position: center;
        }

        .card-back {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            display: flex;
            justify-content: center;
            align-items: center;
            transform: rotateY(180deg);
        }

        .card-back::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-image: url("data:image/svg+xml,%3Csvg width='40' height='40' viewBox='0 0 40 40' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='%23ffffff' fill-opacity='0.1' fill-rule='evenodd'%3E%3Cpath d='M0 40L40 0H20L0 20M40 40V20L20 40'/%3E%3C/g%3E%3C/svg%3E");
            z-index: 0;
            border-radius: 10px;
        }

        .card-back-logo {
            font-family: 'Orbitron', sans-serif;
            font-size: 1.8rem;
            font-weight: bold;
            z-index: 1;
            text-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
        }

        .card-front {
            background: white;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: space-between;
            padding: 15px;
            box-sizing: border-box;
        }

        .card-header {
            width: 100%;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .card-name {
            font-weight: bold;
            font-size: 1.2rem;
            max-width: 70%;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .card-rarity {
            text-transform: uppercase;
            font-size: 0.8rem;
            font-weight: 900;
            padding: 3px 8px;
            border-radius: 12px;
            letter-spacing: 0.5px;
        }

        .card-rarity.common {
            background-color: var(--common-color);
            color: #333;
        }

        .card-rarity.uncommon {
            background-color: var(--uncommon-color);
            color: white;
        }

        .card-rarity.rare {
            background-color: var(--rare-color);
            color: white;
        }

        .card-rarity.epic {
            background-color: var(--epic-color);
            color: white;
        }

        .card-rarity.legendary {
            background-color: var(--legendary-color);
            color: #333;
            animation: glow 2s infinite alternate;
        }

        .card-rarity.limited {
            background: linear-gradient(45deg, #ff4500, #ff9800, #ffeb3b);
            color: #333;
            animation: glow 2s infinite alternate;
        }

        .card-image {
            width: 150px;
            height: 150px;
            background-color: #f0f0f0;
            border-radius: 10px;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            position: relative;
        }

        .card-image svg, .card-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .card-stats {
            width: 100%;
            display: flex;
            justify-content: space-between;
            font-size: 0.9rem;
        }

        .card-value {
            display: flex;
            align-items: center;
            gap: 5px;
            font-weight: bold;
        }

        .card-level {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .common {
            border-color: var(--common-color);
            box-shadow: 0 0 10px rgba(184, 184, 184, 0.5);
        }

        .uncommon {
            border-color: var(--uncommon-color);
            box-shadow: 0 0 15px rgba(76, 175, 80, 0.5);
        }

        .rare {
            border-color: var(--rare-color);
            box-shadow: 0 0 20px rgba(33, 150, 243, 0.5);
        }

        .epic {
            border-color: var(--epic-color);
            box-shadow: 0 0 25px rgba(156, 39, 176, 0.5);
        }

        .legendary {
            border-color: var(--legendary-color);
            box-shadow: 0 0 30px rgba(255, 193, 7, 0.7);
        }

        .limited {
            border-image: linear-gradient(45deg, #ff4500, #ff9800, #ffeb3b) 1;
            box-shadow: 0 0 30px rgba(255, 140, 0, 0.7);
        }

        .stats-section {
            flex: 1;
            min-width: 300px;
            display: flex;
            flex-direction: column;
            padding: 20px;
            border-radius: 20px;
            background: linear-gradient(145deg, rgba(255, 255, 255, 0.1), rgba(255, 255, 255, 0.05));
            backdrop-filter: blur(10px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .dark .stats-section {
            background: linear-gradient(145deg, rgba(30, 30, 40, 0.6), rgba(20, 20, 30, 0.3));
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .stats-title {
            margin-top: 0;
            color: var(--primary);
            font-family: 'Orbitron', sans-serif;
            margin-bottom: 15px;
            border-bottom: 2px solid var(--primary);
            padding-bottom: 10px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: transform 0.3s;
        }

        .dark .stat-card {
            background: rgba(255, 255, 255, 0.05);
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-value {
            font-size: 1.8rem;
            font-weight: bold;
            margin: 5px 0;
            color: var(--primary);
        }

        .stat-label {
            font-size: 0.9rem;
            opacity: 0.8;
        }

        .progress-bar {
            width: 100%;
            height: 20px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            margin-top: 20px;
            position: relative;
            overflow: hidden;
        }

        .dark .progress-bar {
            background: rgba(255, 255, 255, 0.05);
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--primary-dark));
            border-radius: 10px;
            width: 0%;
            transition: width 0.5s ease-in-out;
        }

        .progress-label {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 0.8rem;
            font-weight: bold;
            color: white;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
            backdrop-filter: blur(5px);
        }

        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .modal {
            background: var(--bg-light);
            border-radius: 20px;
            padding: 30px;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.3);
            transform: translateY(50px);
            transition: transform 0.5s cubic-bezier(0.23, 1, 0.32, 1);
            position: relative;
            animation: modalIn 0.5s forwards;
        }

        .dark .modal {
            background: var(--bg-dark);
            color: var(--text-dark);
        }

        .modal.active {
            transform: translateY(0);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--primary);
        }

        .modal-title {
            font-family: 'Orbitron', sans-serif;
            font-size: 1.5rem;
            color: var(--primary);
            margin: 0;
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-light);
            transition: color 0.2s;
        }

        .dark .close-modal {
            color: var(--text-dark);
        }

        .close-modal:hover {
            color: var(--primary);
        }

        .modal-content {
            margin-bottom: 20px;
        }

        .modal-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        .inventory-modal .modal {
            max-width: 800px;
        }

        .inventory-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .inventory-card {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 15px;
            cursor: pointer;
            transition: transform 0.3s;
            position: relative;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .dark .inventory-card {
            background: rgba(255, 255, 255, 0.05);
        }

        .inventory-card:hover {
            transform: translateY(-5px);
        }

        .inventory-card-image {
            width: 80px;
            height: 80px;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 10px;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .inventory-card-image img, .inventory-card-image svg {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .inventory-card-info {
            text-align: center;
            width: 100%;
        }

        .inventory-card-name {
            font-weight: bold;
            font-size: 0.9rem;
            margin-bottom: 5px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .inventory-card-rarity {
            text-transform: uppercase;
            font-size: 0.7rem;
            font-weight: bold;
            padding: 2px 5px;
            border-radius: 10px;
            display: inline-block;
            margin-bottom: 5px;
        }

        .inventory-card-value {
            font-size: 0.9rem;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }

        .inventory-actions {
            position: absolute;
            top: 5px;
            right: 5px;
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .inventory-action-btn {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            font-size: 0.8rem;
            border: none;
            color: white;
            transition: all 0.2s;
        }

        .sell-btn {
            background: linear-gradient(45deg, #f44336, #e91e63);
        }

        .craft-select-btn {
            background: linear-gradient(45deg, #9c27b0, #673ab7);
        }

        .inventory-action-btn:hover {
            transform: scale(1.1);
        }

        .craft-modal .modal {
            max-width: 800px;
        }

        .craft-tabs {
            display: flex;
            border-bottom: 2px solid var(--primary);
            margin-bottom: 20px;
        }

        .craft-tab {
            padding: 10px 20px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            font-weight: bold;
            transition: all 0.3s;
        }

        .craft-tab.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
        }

        .craft-content {
            display: none;
        }

        .craft-content.active {
            display: block;
        }

        .craft-recipe-card {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            border: 2px solid transparent;
        }

        .dark .craft-recipe-card {
            background: rgba(255, 255, 255, 0.05);
        }

        .craft-recipe-card:hover {
            transform: translateY(-5px);
        }

        .craft-recipe-card.selected {
            border-color: var(--primary);
            background: rgba(93, 92, 222, 0.1);
        }

        .craft-recipe-header {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }

        .craft-recipe-icon {
            font-size: 2rem;
            margin-right: 15px;
            color: var(--primary);
        }

        .craft-recipe-title {
            font-weight: bold;
            font-size: 1.2rem;
            margin: 0;
        }

        .craft-recipe-formula {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: rgba(0, 0, 0, 0.05);
            border-radius: 10px;
            padding: 15px;
            margin-top: 10px;
        }

        .dark .craft-recipe-formula {
            background: rgba(255, 255, 255, 0.03);
        }

        .craft-formula-inputs {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .craft-formula-output {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .craft-arrow {
            font-size: 1.5rem;
            margin: 0 15px;
            color: var(--primary);
        }

        .craft-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            padding: 10px;
            min-width: 70px;
        }

        .dark .craft-item {
            background: rgba(255, 255, 255, 0.1);
        }

        .craft-item-icon {
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            margin-bottom: 5px;
        }

        .craft-item-text {
            font-size: 0.8rem;
            font-weight: bold;
        }

        .craft-section-title {
            font-family: 'Orbitron', sans-serif;
            color: var(--primary);
            margin-top: 30px;
            margin-bottom: 15px;
            padding-bottom: 5px;
            border-bottom: 1px solid var(--primary);
        }

        .craft-cards-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 15px;
            margin-top: 15px;
            max-height: 300px;
            overflow-y: auto;
            padding: 5px;
        }

        .craft-card-item {
            position: relative;
            cursor: pointer;
            transition: transform 0.3s;
        }

        .craft-card-item:hover {
            transform: translateY(-5px);
        }

        .craft-card-item.selected {
            border: 2px solid var(--primary);
        }

        .craft-selection-status {
            margin-top: 20px;
            padding: 15px;
            border-radius: 10px;
            background: rgba(93, 92, 222, 0.1);
        }

        .craft-selection-cards {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 15px;
        }

        .craft-selection-card {
            position: relative;
            border-radius: 10px;
            overflow: hidden;
            width: 100px;
            height: 140px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .craft-selection-card img, .craft-selection-card svg {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .craft-selection-remove {
            position: absolute;
            top: 5px;
            right: 5px;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: rgba(244, 67, 54, 0.9);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-weight: bold;
            z-index: 1;
        }

        .craft-preview {
            margin-top: 30px;
            padding: 20px;
            border-radius: 15px;
            background: rgba(255, 255, 255, 0.1);
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
        }

        .dark .craft-preview {
            background: rgba(255, 255, 255, 0.05);
        }

        .craft-preview-title {
            font-family: 'Orbitron', sans-serif;
            color: var(--primary);
            margin-top: 0;
            margin-bottom: 20px;
        }

        .craft-preview-cards {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            margin-bottom: 20px;
        }

        .craft-preview-arrow {
            font-size: 2rem;
            color: var(--primary);
            animation: pulse 2s infinite;
        }

        .craft-preview-output {
            border: 2px dashed var(--primary);
            border-radius: 15px;
            width: 140px;
            height: 200px;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 10px;
            background: rgba(93, 92, 222, 0.1);
        }

        .craft-preview-output.has-card {
            border-style: solid;
        }

        .craft-preview-description {
            opacity: 0.8;
            margin-bottom: 20px;
        }

        .market-modal .modal {
            max-width: 900px;
        }

        .market-categories {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            overflow-x: auto;
            padding-bottom: 10px;
        }

        .market-category {
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 30px;
            padding: 8px 15px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap;
        }

        .market-category:hover, .market-category.active {
            background: var(--primary-dark);
            transform: translateY(-2px);
        }

        .market-items {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 20px;
        }

        .market-item {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .dark .market-item {
            background: rgba(255, 255, 255, 0.05);
        }

        .market-item:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
        }

        .market-item-image {
            width: 80px;
            height: 80px;
            margin-bottom: 15px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 2.5rem;
            color: var(--primary);
        }

        .market-item-title {
            font-weight: bold;
            font-size: 1.1rem;
            margin-bottom: 10px;
        }

        .market-item-description {
            font-size: 0.9rem;
            opacity: 0.8;
            margin-bottom: 15px;
        }

        .market-item-price {
            background: var(--primary);
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 5px;
            margin-top: auto;
        }

        .notification {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.9);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            transition: transform 0.3s, opacity 0.3s;
            transform: translateY(100px);
            opacity: 0;
            max-width: 300px;
            backdrop-filter: blur(10px);
            border-left: 4px solid var(--primary);
        }

        .dark .notification {
            background: rgba(30, 30, 40, 0.9);
            color: var(--text-dark);
        }

        .notification.show {
            transform: translateY(0);
            opacity: 1;
        }

        .notification-title {
            font-weight: bold;
            margin-bottom: 5px;
            font-size: 1.1rem;
        }

        .notification-message {
            font-size: 0.9rem;
        }

        .notification.success {
            border-left-color: #4caf50;
        }

        .notification.error {
            border-left-color: #f44336;
        }

        .notification.warning {
            border-left-color: #ff9800;
        }

        .confetti {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 999;
            pointer-events: none;
        }

        @keyframes flip {
            0% { transform: rotateY(0deg); }
            100% { transform: rotateY(180deg); }
        }

        @keyframes roll {
            0% { 
                transform: translateX(-300px) rotateY(0deg); 
                opacity: 0;
            }
            10% {
                opacity: 1;
            }
            90% {
                transform: translateX(50px) rotateY(1800deg);
            }
            100% { 
                transform: translateX(0) rotateY(1800deg);
            }
        }

        @keyframes glow {
            0% { box-shadow: 0 0 10px rgba(255, 193, 7, 0.7); }
            100% { box-shadow: 0 0 30px rgba(255, 193, 7, 0.9); }
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.8; }
            100% { opacity: 1; }
        }

        @keyframes spinner {
            to { transform: rotate(360deg); }
        }

        @keyframes modalIn {
            from {
                opacity: 0;
                transform: translateY(50px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Responsive design */
        @media (max-width: 768px) {
            .game-title {
                font-size: 1.8rem;
            }

            .header {
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
            }

            .header-center {
                width: 100%;
                justify-content: space-between;
            }

            .nav-buttons {
                width: 100%;
                justify-content: space-between;
            }

            .button {
                padding: 8px 15px;
                font-size: 0.9rem;
            }

            .button.primary {
                font-size: 1rem;
                padding: 10px 20px;
            }

            .currency-display {
                font-size: 1.2rem;
                padding: 6px 12px;
            }

            .main-section {
                flex-direction: column;
            }

            .roll-section, .stats-section {
                width: 100%;
            }

            .inventory-grid, .market-items {
                grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            }

            .card {
                width: 180px;
                height: 260px;
            }

            .roll-area {
                height: 280px;
            }

            .user-profile {
                margin-right: 0;
                margin-bottom: 10px;
            }
        }

        @media (max-width: 480px) {
            .container {
                padding: 10px;
            }

            .game-title {
                font-size: 1.5rem;
            }

            .card {
                width: 160px;
                height: 230px;
            }

            .card-image {
                width: 120px;
                height: 120px;
            }

            .inventory-grid, .market-items {
                grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            }

            .roll-area {
                height: 240px;
            }

            .auth-container {
                padding: 30px 20px;
            }

            .auth-title {
                font-size: 1.5rem;
            }
        }
    </style>
</head>
<body>
    <!-- Loading Screen -->
    <div class="loading-screen" id="loadingScreen">
        <div class="loading-spinner"></div>
        <div class="loading-text">Loading Card Collector Pro...</div>
    </div>

    <!-- Authentication Screen -->
    <div class="auth-screen" id="authScreen">
        <div class="auth-container">
            <h1 class="auth-title">Card Collector Pro</h1>
            <form class="auth-form" id="authForm">
                <input type="email" class="auth-input" id="emailInput" placeholder="Email" required>
                <input type="password" class="auth-input" id="passwordInput" placeholder="Password" required>
                <button type="submit" class="auth-button" id="authSubmitBtn">Sign In</button>
                <div class="auth-error" id="authError"></div>
                <div class="auth-toggle" id="authToggle">Don't have an account? Sign up</div>
            </form>
        </div>
    </div>

    <div class="container" id="gameContainer">
        <header class="header">
            <h1 class="game-title">Card Collector Pro</h1>
            
            <div class="header-center">
                <div class="user-profile" id="userProfile">
                    <div class="user-avatar" id="userAvatar">U</div>
                    <div class="user-info">
                        <div class="user-name" id="userName">Player</div>
                        <div class="user-level" id="userLevel">Level 1</div>
                    </div>
                </div>
                
                <div class="currency-display">
                    <span class="currency-icon">💎</span>
                    <span class="currency-value">0</span>
                </div>
                
                <div class="sync-status" id="syncStatus">
                    <span>✓ Synced</span>
                </div>
            </div>
            
            <div class="nav-buttons">
                <button class="button inventory-btn" id="openInventory">Inventory</button>
                <button class="button market-btn" id="openMarket">Market</button>
                <button class="button craft-btn" id="openCraft">Craft</button>
                <button class="button profile-btn" id="openProfile">Profile</button>
                <button class="button logout-btn" id="logoutBtn">Logout</button>
            </div>
            
            <button class="button theme-toggle" id="themeToggle">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>
            </button>
        </header>

        <div class="main-section">
            <div class="roll-section">
                <div class="roll-area" id="rollArea">
                    <div class="card" id="card">
                        <div class="card-face card-back">
                            <span class="card-back-logo">CCP</span>
                        </div>
                        <div class="card-face card-front">
                            <!-- Card content will be added dynamically -->
                        </div>
                    </div>
                </div>
                <button class="button primary" id="rollButton">Roll Card (50 💎)</button>
            </div>

            <div class="stats-section">
                <h2 class="stats-title">Collection Stats</h2>
                <div class="stats-grid">
                    <div class="stat-card">
                        <span class="stat-value" id="totalRolls">0</span>
                        <span class="stat-label">Total Rolls</span>
                    </div>
                    <div class="stat-card">
                        <span class="stat-value" id="cardsCollected">0</span>
                        <span class="stat-label">Cards Collected</span>
                    </div>
                    <div class="stat-card">
                        <span class="stat-value" id="cardsSold">0</span>
                        <span class="stat-label">Cards Sold</span>
                    </div>
                    <div class="stat-card">
                        <span class="stat-value" id="cardsCrafted">0</span>
                        <span class="stat-label">Cards Crafted</span>
                    </div>
                    <div class="stat-card">
                        <span class="stat-value" id="playerLevel">1</span>
                        <span class="stat-label">Player Level</span>
                    </div>
                    <div class="stat-card">
                        <span class="stat-value" id="totalValue">0</span>
                        <span class="stat-label">Collection Value</span>
                    </div>
                </div>

                <h3 class="stats-title">Rarity Breakdown</h3>
                <div class="stats-grid">
                    <div class="stat-card">
                        <span class="stat-value" id="commonCount">0</span>
                        <span class="stat-label">Common</span>
                    </div>
                    <div class="stat-card">
                        <span class="stat-value" id="uncommonCount">0</span>
                        <span class="stat-label">Uncommon</span>
                    </div>
                    <div class="stat-card">
                        <span class="stat-value" id="rareCount">0</span>
                        <span class="stat-label">Rare</span>
                    </div>
                    <div class="stat-card">
                        <span class="stat-value" id="epicCount">0</span>
                        <span class="stat-label">Epic</span>
                    </div>
                    <div class="stat-card">
                        <span class="stat-value" id="legendaryCount">0</span>
                        <span class="stat-label">Legendary</span>
                    </div>
                    <div class="stat-card">
                        <span class="stat-value" id="limitedCount">0</span>
                        <span class="stat-label">Limited</span>
                    </div>
                </div>

                <div class="collection-progress">
                    <h3 class="stats-title">Collection Progress</h3>
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill"></div>
                        <div class="progress-label" id="progressLabel">0%</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Roll Result Modal -->
        <div class="modal-overlay" id="rollResultModal">
            <div class="modal">
                <div class="modal-header">
                    <h2 class="modal-title">New Card!</h2>
                    <button class="close-modal" id="closeRollModal">×</button>
                </div>
                <div class="modal-content">
                    <div id="rollResultContent" class="text-center"></div>
                </div>
                <div class="modal-buttons">
                    <button class="button sell-all-btn" id="sellCardBtn">Sell Card</button>
                    <button class="button primary" id="keepCardBtn">Keep Card</button>
                </div>
            </div>
        </div>

        <!-- Inventory Modal -->
        <div class="modal-overlay inventory-modal" id="inventoryModal">
            <div class="modal">
                <div class="modal-header">
                    <h2 class="modal-title">Your Inventory</h2>
                    <button class="close-modal" id="closeInventoryModal">×</button>
                </div>
                <div class="modal-content">
                    <p id="inventoryCount">Cards: 0/6</p>
                    <div class="inventory-grid" id="inventoryGrid">
                        <!-- Inventory cards will be added here dynamically -->
                    </div>
                </div>
                <div class="modal-buttons">
                    <button class="button sell-all-btn" id="sellAllBtn">Sell All Cards</button>
                    <button class="button primary" id="sortInventoryBtn">Sort Inventory</button>
                </div>
            </div>
        </div>

        <!-- Craft Modal -->
        <div class="modal-overlay craft-modal" id="craftModal">
            <div class="modal">
                <div class="modal-header">
                    <h2 class="modal-title">Craft Cards</h2>
                    <button class="close-modal" id="closeCraftModal">×</button>
                </div>
                <div class="modal-content">
                    <!-- Crafting Tabs -->
                    <div class="craft-tabs">
                        <div class="craft-tab active" data-tab="recipe">1. Choose Recipe</div>
                        <div class="craft-tab" data-tab="select">2. Select Cards</div>
                        <div class="craft-tab" data-tab="preview">3. Preview & Craft</div>
                    </div>
                    
                    <!-- Recipe Selection -->
                    <div class="craft-content active" id="recipe-tab">
                        <p>Select a crafting recipe to combine your cards:</p>
                        
                        <div class="craft-recipe-card" data-recipe="common-to-uncommon">
                            <div class="craft-recipe-header">
                                <div class="craft-recipe-icon">🔄</div>
                                <h3 class="craft-recipe-title">Basic Upgrade</h3>
                            </div>
                            <div class="craft-recipe-formula">
                                <div class="craft-formula-inputs">
                                    <div class="craft-item common">
                                        <div class="craft-item-icon">C</div>
                                        <div class="craft-item-text">Common</div>
                                    </div>
                                    <div class="craft-item common">
                                        <div class="craft-item-icon">C</div>
                                        <div class="craft-item-text">Common</div>
                                    </div>
                                    <div class="craft-item common">
                                        <div class="craft-item-icon">C</div>
                                        <div class="craft-item-text">Common</div>
                                    </div>
                                </div>
                                <div class="craft-arrow">→</div>
                                <div class="craft-formula-output">
                                    <div class="craft-item uncommon">
                                        <div class="craft-item-icon">U</div>
                                        <div class="craft-item-text">Uncommon</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="craft-recipe-card" data-recipe="uncommon-to-rare">
                            <div class="craft-recipe-header">
                                <div class="craft-recipe-icon">⬆️</div>
                                <h3 class="craft-recipe-title">Rare Fusion</h3>
                            </div>
                            <div class="craft-recipe-formula">
                                <div class="craft-formula-inputs">
                                    <div class="craft-item uncommon">
                                        <div class="craft-item-icon">U</div>
                                        <div class="craft-item-text">Uncommon</div>
                                    </div>
                                    <div class="craft-item uncommon">
                                        <div class="craft-item-icon">U</div>
                                        <div class="craft-item-text">Uncommon</div>
                                    </div>
                                    <div class="craft-item uncommon">
                                        <div class="craft-item-icon">U</div>
                                        <div class="craft-item-text">Uncommon</div>
                                    </div>
                                </div>
                                <div class="craft-arrow">→</div>
                                <div class="craft-formula-output">
                                    <div class="craft-item rare">
                                        <div class="craft-item-icon">R</div>
                                        <div class="craft-item-text">Rare</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="craft-recipe-card" data-recipe="rare-to-epic">
                            <div class="craft-recipe-header">
                                <div class="craft-recipe-icon">✨</div>
                                <h3 class="craft-recipe-title">Epic Creation</h3>
                            </div>
                            <div class="craft-recipe-formula">
                                <div class="craft-formula-inputs">
                                    <div class="craft-item rare">
                                        <div class="craft-item-icon">R</div>
                                        <div class="craft-item-text">Rare</div>
                                    </div>
                                    <div class="craft-item rare">
                                        <div class="craft-item-icon">R</div>
                                        <div class="craft-item-text">Rare</div>
                                    </div>
                                    <div class="craft-item rare">
                                        <div class="craft-item-icon">R</div>
                                        <div class="craft-item-text">Rare</div>
                                    </div>
                                </div>
                                <div class="craft-arrow">→</div>
                                <div class="craft-formula-output">
                                    <div class="craft-item epic">
                                        <div class="craft-item-icon">E</div>
                                        <div class="craft-item-text">Epic</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="craft-recipe-card" data-recipe="epic-to-legendary">
                            <div class="craft-recipe-header">
                                <div class="craft-recipe-icon">🌟</div>
                                <h3 class="craft-recipe-title">Legendary Forge</h3>
                            </div>
                            <div class="craft-recipe-formula">
                                <div class="craft-formula-inputs">
                                    <div class="craft-item epic">
                                        <div class="craft-item-icon">E</div>
                                        <div class="craft-item-text">Epic</div>
                                    </div>
                                    <div class="craft-item epic">
                                        <div class="craft-item-icon">E</div>
                                        <div class="craft-item-text">Epic</div>
                                    </div>
                                    <div class="craft-item epic">
                                        <div class="craft-item-icon">E</div>
                                        <div class="craft-item-text">Epic</div>
                                    </div>
                                </div>
                                <div class="craft-arrow">→</div>
                                <div class="craft-formula-output">
                                    <div class="craft-item legendary">
                                        <div class="craft-item-icon">L</div>
                                        <div class="craft-item-text">Legendary</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="craft-recipe-card" data-recipe="mixed-limited">
                            <div class="craft-recipe-header">
                                <div class="craft-recipe-icon">🔮</div>
                                <h3 class="craft-recipe-title">Limited Edition</h3>
                            </div>
                            <div class="craft-recipe-formula">
                                <div class="craft-formula-inputs">
                                    <div class="craft-item common">
                                        <div class="craft-item-icon">C</div>
                                        <div class="craft-item-text">Common</div>
                                    </div>
                                    <div class="craft-item uncommon">
                                        <div class="craft-item-icon">U</div>
                                        <div class="craft-item-text">Uncommon</div>
                                    </div>
                                    <div class="craft-item rare">
                                        <div class="craft-item-icon">R</div>
                                        <div class="craft-item-text">Rare</div>
                                    </div>
                                    <div class="craft-item epic">
                                        <div class="craft-item-icon">E</div>
                                        <div class="craft-item-text">Epic</div>
                                    </div>
                                    <div class="craft-item legendary">
                                        <div class="craft-item-icon">L</div>
                                        <div class="craft-item-text">Legendary</div>
                                    </div>
                                </div>
                                <div class="craft-arrow">→</div>
                                <div class="craft-formula-output">
                                    <div class="craft-item limited">
                                        <div class="craft-item-icon">🌈</div>
                                        <div class="craft-item-text">Limited</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Card Selection -->
                    <div class="craft-content" id="select-tab">
                        <div id="craft-recipe-display">
                            <h3>Selected Recipe: <span id="selected-recipe-name">None</span></h3>
                            <p id="recipe-requirements">Please select a recipe first.</p>
                        </div>
                        
                        <h3 class="craft-section-title">Select Cards from Your Inventory</h3>
                        <p id="selection-instruction">Select cards that match the recipe requirements.</p>
                        
                        <div class="craft-cards-container" id="craft-inventory-grid">
                            <!-- Cards will be added here dynamically -->
                        </div>
                        
                        <div class="craft-selection-status">
                            <h4>Selected Cards: <span id="selected-count">0</span>/<span id="required-count">3</span></h4>
                            <div class="craft-selection-cards" id="craft-selection-display">
                                <!-- Selected cards will appear here -->
                            </div>
                        </div>
                    </div>
                    
                    <!-- Preview and Craft -->
                    <div class="craft-content" id="preview-tab">
                        <div class="craft-preview">
                            <h3 class="craft-preview-title">Crafting Preview</h3>
                            
                            <div class="craft-preview-cards">
                                <div id="craft-input-cards">
                                    <!-- Input cards preview -->
                                </div>
                                
                                <div class="craft-preview-arrow">→</div>
                                
                                <div class="craft-preview-output" id="craft-result-preview">
                                    <div id="craft-result-placeholder">?</div>
                                    <!-- Result card preview will appear here -->
                                </div>
                            </div>
                            
                            <p class="craft-preview-description">
                                You are about to combine your selected cards to create a new card.
                                This action cannot be undone.
                            </p>
                        </div>
                    </div>
                </div>
                <div class="modal-buttons">
                    <button class="button" id="craftBackBtn">Back</button>
                    <button class="button primary" id="craftNextBtn">Next</button>
                    <button class="button primary" id="executeCraftBtn" style="display: none;">Craft!</button>
                </div>
            </div>
        </div>

        <!-- Market Modal -->
        <div class="modal-overlay market-modal" id="marketModal">
            <div class="modal">
                <div class="modal-header">
                    <h2 class="modal-title">Market</h2>
                    <button class="close-modal" id="closeMarketModal">×</button>
                </div>
                <div class="modal-content">
                    <div class="market-categories">
                        <button class="market-category active" data-category="powerups">Power-Ups</button>
                        <button class="market-category" data-category="boosts">Roll Boosts</button>
                        <button class="market-category" data-category="special">Special Items</button>
                        <button class="market-category" data-category="currency">Currency</button>
                    </div>
                    <div class="market-items" id="marketItems">
                        <!-- Market items will be added here dynamically -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Profile Modal -->
        <div class="modal-overlay" id="profileModal">
            <div class="modal">
                <div class="modal-header">
                    <h2 class="modal-title">Player Profile</h2>
                    <button class="close-modal" id="closeProfileModal">×</button>
                </div>
                <div class="modal-content">
                    <div id="profileContent">
                        <!-- Profile content will be added dynamically -->
                    </div>
                </div>
                <div class="modal-buttons">
                    <button class="button" id="exportDataBtn">Export Data</button>
                    <button class="button primary" id="shareProfileBtn">Share Profile</button>
                </div>
            </div>
        </div>

        <!-- Notification -->
        <div class="notification" id="notification">
            <div class="notification-title">Title</div>
            <div class="notification-message">Message goes here</div>
        </div>

        <!-- Canvas for confetti -->
        <canvas id="confetti-canvas" class="confetti"></canvas>
    </div>

    <script>
        // Supabase Configuration
        const SUPABASE_URL = 'https://agurkpnwtpogmrssvitw.supabase.co'; // Replace with your Supabase URL
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFndXJrcG53dHBvZ21yc3N2aXR3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTMxMTkzNDMsImV4cCI6MjA2ODY5NTM0M30.aWVh-H3Pm-7Hj97seU3Ey6nRmUJlD6AM6zV6_mMrnDA'; // Replace with your Supabase anon key

        // Initialize Supabase client
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // Application State
        const app = {
            user: null,
            isLoading: true,
            isSignUp: false,
            currentCard: null,
            saveTimeout: null
        };

        // MAIN GAME LOGIC
        const game = {
            currency: 1000,
            rollCost: 50,
            inventory: [],
            inventoryLimit: 6,
            level: 1,
            experience: 0,
            experienceToNext: 100,
            collection: {
                totalRolls: 0,
                cardsSold: 0,
                cardsCrafted: 0,
                commonCount: 0,
                uncommonCount: 0,
                rareCount: 0,
                epicCount: 0,
                legendaryCount: 0,
                limitedCount: 0
            },
            powerUps: {
                luckyCharm: 0,
                doubleCurrency: 0,
                rareBoost: 0
            },
            rarityChances: {
                common: 100,
                uncommon: 60,
                rare: 30,
                epic: 9,
                legendary: 1
            },
            rarityValues: {
                common: 25,
                uncommon: 75,
                rare: 200,
                epic: 500,
                legendary: 2000,
                limited: 5000
            },
            cardTypes: [
                "Warrior", "Mage", "Rogue", "Paladin", "Hunter", "Priest", 
                "Warlock", "Druid", "Shaman", "Monk", "Necromancer", "Knight",
                "Archer", "Sorcerer", "Beast", "Dragon", "Demon", "Angel",
                "Goblin", "Orc", "Elf", "Dwarf", "Troll", "Undead",
                "Elemental", "Golem", "Fairy", "Phoenix", "Unicorn", "Titan"
            ],
            cardPrefixes: [
                "Ancient", "Mystic", "Divine", "Cursed", "Enchanted", "Legendary",
                "Ethereal", "Savage", "Mighty", "Heroic", "Royal", "Shadow",
                "Golden", "Silver", "Bronze", "Platinum", "Crystal", "Jade",
                "Emerald", "Ruby", "Sapphire", "Diamond", "Onyx", "Obsidian"
            ],
            crafting: {
                currentTab: 'recipe',
                selectedRecipe: null,
                selectedCards: [],
                previewCard: null
            },
            marketItems: {
                powerups: [
                    {
                        id: 'lucky-charm',
                        name: 'Lucky Charm',
                        description: 'Increases rare, epic, and legendary drop rates for 5 rolls',
                        price: 200,
                        icon: '🍀',
                        effect: () => {
                            game.powerUps.luckyCharm += 5;
                            showNotification('Power-Up Activated', 'Lucky Charm will boost your next 5 rolls!', 'success');
                        }
                    },
                    {
                        id: 'double-currency',
                        name: 'Double Currency',
                        description: 'Double the currency from selling cards for 10 minutes',
                        price: 300,
                        icon: '💰',
                        effect: () => {
                            game.powerUps.doubleCurrency += 10;
                            showNotification('Power-Up Activated', 'Double Currency active for 10 minutes!', 'success');
                            setTimeout(() => {
                                game.powerUps.doubleCurrency = Math.max(0, game.powerUps.doubleCurrency - 10);
                                showNotification('Power-Up Expired', 'Double Currency has expired', 'warning');
                            }, 600000);
                        }
                    },
                    {
                        id: 'rare-boost',
                        name: 'Rare Boost',
                        description: 'Your next roll is guaranteed to be rare or better',
                        price: 400,
                        icon: '✨',
                        effect: () => {
                            game.powerUps.rareBoost += 1;
                            showNotification('Power-Up Activated', 'Your next roll will be rare or better!', 'success');
                        }
                    }
                ],
                boosts: [
                    {
                        id: 'multi-roll',
                        name: 'Multi Roll',
                        description: 'Roll 5 cards at once with a 10% discount',
                        price: 225,
                        icon: '🎲',
                        effect: () => {
                            if (game.currency < 225) {
                                showNotification('Not Enough Currency', 'You need 225 💎 for a Multi Roll', 'error');
                                return;
                            }
                            
                            game.currency -= 225;
                            updateCurrencyDisplay();
                            
                            let rolledCards = [];
                            for (let i = 0; i < 5; i++) {
                                const card = rollCard();
                                rolledCards.push(card);
                                game.collection.totalRolls++;
                            }
                            
                            rolledCards.sort((a, b) => {
                                const rarityOrder = {
                                    'common': 0,
                                    'uncommon': 1,
                                    'rare': 2,
                                    'epic': 3,
                                    'legendary': 4,
                                    'limited': 5
                                };
                                return rarityOrder[b.rarity] - rarityOrder[a.rarity];
                            });
                            
                            let message = 'You rolled: ';
                            rolledCards.forEach(card => {
                                message += `<br>${card.name} (${card.rarity})`;
                                if (game.inventory.length < game.inventoryLimit) {
                                    game.inventory.push(card);
                                    game.collection[card.rarity + 'Count']++;
                                } else {
                                    sellCard(card);
                                }
                            });
                            
                            showNotification('Multi Roll Complete', message, 'success');
                            addExperience(25);
                            updateStats();
                            saveGameData();
                        }
                    },
                    {
                        id: 'epic-guarantee',
                        name: 'Epic Guarantee',
                        description: 'Your next roll is guaranteed to be an epic card',
                        price: 600,
                        icon: '🔮',
                        effect: () => {
                            if (game.currency < 600) {
                                showNotification('Not Enough Currency', 'You need 600 💎 for an Epic Guarantee', 'error');
                                return;
                            }
                            
                            game.currency -= 600;
                            updateCurrencyDisplay();
                            
                            const card = createCard('epic');
                            game.collection.totalRolls++;
                            
                            if (game.inventory.length < game.inventoryLimit) {
                                game.inventory.push(card);
                                game.collection.epicCount++;
                                showCard(card);
                            } else {
                                sellCard(card);
                                showNotification('Inventory Full', `Sold ${card.name} for ${calculateSellValue(card)} 💎`, 'warning');
                            }
                            
                            addExperience(50);
                            updateStats();
                            saveGameData();
                        }
                    }
                ],
                special: [
                    {
                        id: 'inventory-upgrade',
                        name: 'Inventory Expansion',
                        description: 'Increase your inventory limit by 2 slots',
                        price: 1000,
                        icon: '📦',
                        effect: () => {
                            game.inventoryLimit += 2;
                            showNotification('Inventory Expanded', `Your inventory limit is now ${game.inventoryLimit}`, 'success');
                        }
                    },
                    {
                        id: 'legendary-chance',
                        name: 'Legendary Finder',
                        description: 'Permanently increase legendary drop rate by 0.5%',
                        price: 2000,
                        icon: '🌟',
                        effect: () => {
                            game.rarityChances.legendary += 1;
                            showNotification('Permanent Upgrade', 'Your legendary drop rate has increased permanently!', 'success');
                        }
                    }
                ],
                currency: [
                    {
                        id: 'small-pack',
                        name: 'Small Gem Pack',
                        description: 'Purchase 500 gems',
                        price: 0,
                        realPrice: '$4.99',
                        icon: '💎',
                        effect: () => {
                            game.currency += 500;
                            updateCurrencyDisplay();
                            showNotification('Currency Added', '500 gems have been added to your account!', 'success');
                        }
                    },
                    {
                        id: 'medium-pack',
                        name: 'Medium Gem Pack',
                        description: 'Purchase 1200 gems (10% bonus)',
                        price: 0,
                        realPrice: '$9.99',
                        icon: '💎',
                        effect: () => {
                            game.currency += 1200;
                            updateCurrencyDisplay();
                            showNotification('Currency Added', '1200 gems have been added to your account!', 'success');
                        }
                    },
                    {
                        id: 'large-pack',
                        name: 'Large Gem Pack',
                        description: 'Purchase 2500 gems (25% bonus)',
                        price: 0,
                        realPrice: '$19.99',
                        icon: '💎',
                        effect: () => {
                            game.currency += 2500;
                            updateCurrencyDisplay();
                            showNotification('Currency Added', '2500 gems have been added to your account!', 'success');
                        }
                    }
                ]
            },
            craftingRecipes: {
                'common-to-uncommon': {
                    name: 'Basic Upgrade',
                    input: { rarity: 'common', count: 3 },
                    output: { rarity: 'uncommon', count: 1 }
                },
                'uncommon-to-rare': {
                    name: 'Rare Fusion',
                    input: { rarity: 'uncommon', count: 3 },
                    output: { rarity: 'rare', count: 1 }
                },
                'rare-to-epic': {
                    name: 'Epic Creation',
                    input: { rarity: 'rare', count: 3 },
                    output: { rarity: 'epic', count: 1 }
                },
                'epic-to-legendary': {
                    name: 'Legendary Forge',
                    input: { rarity: 'epic', count: 3 },
                    output: { rarity: 'legendary', count: 1 }
                },
                'mixed-limited': {
                    name: 'Limited Edition',
                    input: { mixed: ['common', 'uncommon', 'rare', 'epic', 'legendary'], count: 1 },
                    output: { rarity: 'limited', count: 1 }
                }
            }
        };

        // DOM Elements
        const elements = {
            loadingScreen: document.getElementById('loadingScreen'),
            authScreen: document.getElementById('authScreen'),
            gameContainer: document.getElementById('gameContainer'),
            authForm: document.getElementById('authForm'),
            emailInput: document.getElementById('emailInput'),
            passwordInput: document.getElementById('passwordInput'),
            authSubmitBtn: document.getElementById('authSubmitBtn'),
            authError: document.getElementById('authError'),
            authToggle: document.getElementById('authToggle'),
            
            userProfile: document.getElementById('userProfile'),
            userAvatar: document.getElementById('userAvatar'),
            userName: document.getElementById('userName'),
            userLevel: document.getElementById('userLevel'),
            syncStatus: document.getElementById('syncStatus'),
            
            currencyValue: document.querySelector('.currency-value'),
            rollButton: document.getElementById('rollButton'),
            rollArea: document.getElementById('rollArea'),
            card: document.getElementById('card'),
            
            totalRolls: document.getElementById('totalRolls'),
            cardsCollected: document.getElementById('cardsCollected'),
            cardsSold: document.getElementById('cardsSold'),
            cardsCrafted: document.getElementById('cardsCrafted'),
            playerLevel: document.getElementById('playerLevel'),
            totalValue: document.getElementById('totalValue'),
            commonCount: document.getElementById('commonCount'),
            uncommonCount: document.getElementById('uncommonCount'),
            rareCount: document.getElementById('rareCount'),
            epicCount: document.getElementById('epicCount'),
            legendaryCount: document.getElementById('legendaryCount'),
            limitedCount: document.getElementById('limitedCount'),
            progressFill: document.getElementById('progressFill'),
            progressLabel: document.getElementById('progressLabel'),
            
            rollResultModal: document.getElementById('rollResultModal'),
            rollResultContent: document.getElementById('rollResultContent'),
            keepCardBtn: document.getElementById('keepCardBtn'),
            sellCardBtn: document.getElementById('sellCardBtn'),
            
            inventoryModal: document.getElementById('inventoryModal'),
            inventoryGrid: document.getElementById('inventoryGrid'),
            inventoryCount: document.getElementById('inventoryCount'),
            
            craftModal: document.getElementById('craftModal'),
            craftTabs: document.querySelectorAll('.craft-tab'),
            craftContents: document.querySelectorAll('.craft-content'),
            recipeCards: document.querySelectorAll('.craft-recipe-card'),
            selectedRecipeName: document.getElementById('selected-recipe-name'),
            recipeRequirements: document.getElementById('recipe-requirements'),
            craftInventoryGrid: document.getElementById('craft-inventory-grid'),
            selectionInstruction: document.getElementById('selection-instruction'),
            selectedCount: document.getElementById('selected-count'),
            requiredCount: document.getElementById('required-count'),
            craftSelectionDisplay: document.getElementById('craft-selection-display'),
            craftInputCards: document.getElementById('craft-input-cards'),
            craftResultPreview: document.getElementById('craft-result-preview'),
            craftBackBtn: document.getElementById('craftBackBtn'),
            craftNextBtn: document.getElementById('craftNextBtn'),
            executeCraftBtn: document.getElementById('executeCraftBtn'),
            
            marketModal: document.getElementById('marketModal'),
            marketItems: document.getElementById('marketItems'),
            
            profileModal: document.getElementById('profileModal'),
            profileContent: document.getElementById('profileContent'),
            
            notification: document.getElementById('notification'),
            
            openInventoryBtn: document.getElementById('openInventory'),
            openMarketBtn: document.getElementById('openMarket'),
            openCraftBtn: document.getElementById('openCraft'),
            openProfileBtn: document.getElementById('openProfile'),
            logoutBtn: document.getElementById('logoutBtn'),
            sellAllBtn: document.getElementById('sellAllBtn'),
            sortInventoryBtn: document.getElementById('sortInventoryBtn'),
            themeToggleBtn: document.getElementById('themeToggle'),
            exportDataBtn: document.getElementById('exportDataBtn'),
            shareProfileBtn: document.getElementById('shareProfileBtn'),
            
            closeRollModal: document.getElementById('closeRollModal'),
            closeInventoryModal: document.getElementById('closeInventoryModal'),
            closeCraftModal: document.getElementById('closeCraftModal'),
            closeMarketModal: document.getElementById('closeMarketModal'),
            closeProfileModal: document.getElementById('closeProfileModal'),
            
            confettiCanvas: document.getElementById('confetti-canvas')
        };

        // Authentication Functions
        async function handleAuth(isSignUp) {
            const email = elements.emailInput.value.trim();
            const password = elements.passwordInput.value.trim();
            
            if (!email || !password) {
                showAuthError('Please fill in all fields');
                return;
            }
            
            if (password.length < 6) {
                showAuthError('Password must be at least 6 characters');
                return;
            }
            
            elements.authSubmitBtn.disabled = true;
            elements.authSubmitBtn.textContent = isSignUp ? 'Creating Account...' : 'Signing In...';
            
            try {
                let result;
                if (isSignUp) {
                    result = await supabase.auth.signUp({
                        email: email,
                        password: password
                    });
                } else {
                    result = await supabase.auth.signInWithPassword({
                        email: email,
                        password: password
                    });
                }
                
                if (result.error) {
                    showAuthError(result.error.message);
                } else {
                    if (isSignUp) {
                        showAuthError('Check your email for confirmation link');
                    } else {
                        showNotification('Welcome Back!', 'Successfully signed in', 'success');
                    }
                }
            } catch (error) {
                showAuthError('An error occurred. Please try again.');
                console.error('Auth error:', error);
            }
            
            elements.authSubmitBtn.disabled = false;
            elements.authSubmitBtn.textContent = isSignUp ? 'Sign Up' : 'Sign In';
        }
        
        function showAuthError(message) {
            elements.authError.textContent = message;
            setTimeout(() => {
                elements.authError.textContent = '';
            }, 5000);
        }
        
        function toggleAuthMode() {
            app.isSignUp = !app.isSignUp;
            
            if (app.isSignUp) {
                elements.authSubmitBtn.textContent = 'Sign Up';
                elements.authToggle.textContent = 'Already have an account? Sign in';
            } else {
                elements.authSubmitBtn.textContent = 'Sign In';
                elements.authToggle.textContent = "Don't have an account? Sign up";
            }
            
            elements.emailInput.value = '';
            elements.passwordInput.value = '';
            elements.authError.textContent = '';
        }
        
        async function signOut() {
            try {
                await supabase.auth.signOut();
                showNotification('Signed Out', 'You have been signed out successfully', 'success');
            } catch (error) {
                console.error('Signout error:', error);
                showNotification('Error', 'Failed to sign out', 'error');
            }
        }

        // Database Functions
        // Replace the saveGameData function with this fixed version:
async function saveGameData() {
    if (!app.user) return;
    
    // Clear any existing timeout
    if (app.saveTimeout) {
        clearTimeout(app.saveTimeout);
    }
    
    // Debounce saves to avoid too many database calls
    app.saveTimeout = setTimeout(async () => {
        try {
            setSyncStatus('syncing');
            
            const gameData = {
                user_id: app.user.id,
                currency: game.currency || 1000,
                inventory: game.inventory || [],
                inventory_limit: game.inventoryLimit || 6,
                level: game.level || 1,
                experience: game.experience || 0,
                experience_to_next: game.experienceToNext || 100,
                collection: game.collection || {
                    totalRolls: 0,
                    cardsSold: 0,
                    cardsCrafted: 0,
                    commonCount: 0,
                    uncommonCount: 0,
                    rareCount: 0,
                    epicCount: 0,
                    legendaryCount: 0,
                    limitedCount: 0
                },
                power_ups: game.powerUps || {
                    luckyCharm: 0,
                    doubleCurrency: 0,
                    rareBoost: 0
                },
                rarity_chances: game.rarityChances || {
                    common: 100,
                    uncommon: 60,
                    rare: 30,
                    epic: 9,
                    legendary: 1
                },
                updated_at: new Date().toISOString()
            };
            
            const { error } = await supabase
                .from('player_data')
                .upsert(gameData, {
                    onConflict: 'user_id'
                });
            
            if (error) {
                console.error('Save error:', error);
                setSyncStatus('error');
            } else {
                setSyncStatus('synced');
            }
        } catch (error) {
            console.error('Save error:', error);
            setSyncStatus('error');
        }
    }, 1000);
}        
        async function loadGameData() {
    if (!app.user) return;
    
    try {
        setSyncStatus('syncing');
        
        const { data, error } = await supabase
            .from('player_data')
            .select('*')
            .eq('user_id', app.user.id)
            .single();
        
        if (error && error.code !== 'PGRST116') {
            console.error('Load error:', error);
            setSyncStatus('error');
            return false;
        }
        
        if (data) {
            // Load existing data
            game.currency = data.currency || 1000;
            game.inventory = data.inventory || [];
            game.inventoryLimit = data.inventory_limit || 6;
            game.level = data.level || 1;
            game.experience = data.experience || 0;
            game.experienceToNext = data.experience_to_next || 100;
            game.collection = data.collection || {
                totalRolls: 0,
                cardsSold: 0,
                cardsCrafted: 0,
                commonCount: 0,
                uncommonCount: 0,
                rareCount: 0,
                epicCount: 0,
                legendaryCount: 0,
                limitedCount: 0
            };
            game.powerUps = data.power_ups || {
                luckyCharm: 0,
                doubleCurrency: 0,
                rareBoost: 0
            };
            game.rarityChances = data.rarity_chances || {
                common: 100,
                uncommon: 60,
                rare: 30,
                epic: 9,
                legendary: 1
            };
            
            updateAllDisplays();
            setSyncStatus('synced');
            return true;
        } else {
            // New user - initialize with defaults and save
            game.currency = 1000;
            game.inventory = [];
            game.inventoryLimit = 6;
            game.level = 1;
            game.experience = 0;
            game.experienceToNext = 100;
            game.collection = {
                totalRolls: 0,
                cardsSold: 0,
                cardsCrafted: 0,
                commonCount: 0,
                uncommonCount: 0,
                rareCount: 0,
                epicCount: 0,
                legendaryCount: 0,
                limitedCount: 0
            };
            game.powerUps = {
                luckyCharm: 0,
                doubleCurrency: 0,
                rareBoost: 0
            };
            game.rarityChances = {
                common: 100,
                uncommon: 60,
                rare: 30,
                epic: 9,
                legendary: 1
            };
            
            await saveGameData();
            updateAllDisplays();
            return false;
        }
    } catch (error) {
        console.error('Load error:', error);
        setSyncStatus('error');
        return false;
    }
}        
        function setSyncStatus(status) {
            const statusElement = elements.syncStatus;
            statusElement.className = `sync-status ${status}`;
            
            switch (status) {
                case 'synced':
                    statusElement.innerHTML = '<span>✓ Synced</span>';
                    break;
                case 'syncing':
                    statusElement.innerHTML = '<span>↻ Syncing...</span>';
                    break;
                case 'error':
                    statusElement.innerHTML = '<span>⚠ Sync Error</span>';
                    break;
            }
        }

        // Experience and Level System
        function addExperience(amount) {
            game.experience += amount;
            
            while (game.experience >= game.experienceToNext) {
                game.experience -= game.experienceToNext;
                game.level++;
                game.experienceToNext = Math.floor(game.experienceToNext * 1.2);
                
                // Level up bonuses
                game.currency += game.level * 50;
                
                showNotification('Level Up!', `Congratulations! You reached level ${game.level}! Bonus: ${game.level * 50} 💎`, 'success');
                confetti.start();
            }
            
            updateAllDisplays();
        }

        // Initialize confetti
        const confetti = {
            canvas: elements.confettiCanvas,
            ctx: elements.confettiCanvas.getContext('2d'),
            particles: [],
            colors: ['#5D5CDE', '#FF4081', '#FFC107', '#29B6F6', '#66BB6A', '#9C27B0'],
            
            init() {
                this.canvas.width = window.innerWidth;
                this.canvas.height = window.innerHeight;
                this.canvas.style.display = 'none';
                
                window.addEventListener('resize', () => {
                    this.canvas.width = window.innerWidth;
                    this.canvas.height = window.innerHeight;
                });
            },
            
            createParticles(count = 100) {
                this.particles = [];
                for (let i = 0; i < count; i++) {
                    this.particles.push({
                        x: Math.random() * this.canvas.width,
                        y: Math.random() * this.canvas.height - this.canvas.height,
                        size: Math.random() * 10 + 5,
                        color: this.colors[Math.floor(Math.random() * this.colors.length)],
                        speed: Math.random() * 5 + 2,
                        rotation: Math.random() * 360,
                        rotationSpeed: (Math.random() - 0.5) * 2
                    });
                }
            },
            
            draw() {
                this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
                
                for (let p of this.particles) {
                    this.ctx.save();
                    this.ctx.translate(p.x, p.y);
                    this.ctx.rotate(p.rotation * Math.PI / 180);
                    this.ctx.fillStyle = p.color;
                    this.ctx.beginPath();
                    this.ctx.rect(-p.size / 2, -p.size / 2, p.size, p.size);
                    this.ctx.fill();
                    this.ctx.restore();
                    
                    p.y += p.speed;
                    p.rotation += p.rotationSpeed;
                    
                    if (p.y > this.canvas.height) {
                        p.y = -p.size;
                        p.x = Math.random() * this.canvas.width;
                    }
                }
                
                if (this.active) {
                    requestAnimationFrame(() => this.draw());
                }
            },
            
            start() {
                this.canvas.style.display = 'block';
                this.active = true;
                this.createParticles();
                this.draw();
                
                setTimeout(() => this.stop(), 3000);
            },
            
            stop() {
                this.active = false;
                this.canvas.style.display = 'none';
            }
        };

        // GAME FUNCTIONS
        
        function rollCard() {
            if (game.currency < game.rollCost) {
                showNotification('Not Enough Currency', `You need ${game.rollCost} 💎 to roll a card`, 'error');
                return null;
            }
            
            game.currency -= game.rollCost;
            updateCurrencyDisplay();
            
            let rarity = determineRarity();
            
            if (game.powerUps.rareBoost > 0) {
                if (rarity === 'common' || rarity === 'uncommon') {
                    rarity = 'rare';
                }
                game.powerUps.rareBoost--;
            }
            
            if (game.powerUps.luckyCharm > 0) {
                const rarityBoost = Math.random();
                if (rarityBoost > 0.7) {
                    if (rarity === 'common') rarity = 'uncommon';
                    else if (rarity === 'uncommon') rarity = 'rare';
                    else if (rarity === 'rare') rarity = 'epic';
                    else if (rarity === 'epic') rarity = 'legendary';
                }
                game.powerUps.luckyCharm--;
            }
            
            const card = createCard(rarity);
            
            game.collection.totalRolls++;
            addExperience(5);
            updateStats();
            saveGameData();
            
            return card;
        }
        
        function determineRarity() {
            const total = 200;
            const roll = Math.floor(Math.random() * total);
            
            let threshold = 0;
            if (roll < (threshold += game.rarityChances.legendary)) return 'legendary';
            if (roll < (threshold += game.rarityChances.epic)) return 'epic';
            if (roll < (threshold += game.rarityChances.rare)) return 'rare';
            if (roll < (threshold += game.rarityChances.uncommon)) return 'uncommon';
            return 'common';
        }
        
        function createCard(rarity) {
            const id = Date.now().toString() + Math.floor(Math.random() * 1000);
            const prefix = game.cardPrefixes[Math.floor(Math.random() * game.cardPrefixes.length)];
            const type = game.cardTypes[Math.floor(Math.random() * game.cardTypes.length)];
            const level = Math.floor(Math.random() * 10) + 1;
            const value = game.rarityValues[rarity];
            
            const seed = Math.floor(Math.random() * 100000);
            const colorMap = {
                common: '#b8b8b8',
                uncommon: '#4caf50',
                rare: '#2196f3',
                epic: '#9c27b0',
                legendary: '#ffc107',
                limited: '#ff4500'
            };
            const primaryColor = colorMap[rarity];
            const secondaryColor = lerpColor(primaryColor, '#ffffff', 0.7);
            
            let patternSvg = '';
            if (rarity === 'common') {
                patternSvg = generateCirclePattern(seed, primaryColor, secondaryColor);
            } else if (rarity === 'uncommon') {
                patternSvg = generateTrianglePattern(seed, primaryColor, secondaryColor);
            } else if (rarity === 'rare') {
                patternSvg = generateHexagonPattern(seed, primaryColor, secondaryColor);
            } else if (rarity === 'epic') {
                patternSvg = generateStarPattern(seed, primaryColor, secondaryColor);
            } else if (rarity === 'legendary') {
                patternSvg = generateDiamondPattern(seed, primaryColor, secondaryColor);
            } else if (rarity === 'limited') {
                patternSvg = generateSpecialPattern(seed);
            }
            
            return {
                id,
                name: `${prefix} ${type}`,
                rarity,
                level,
                value,
                imageSvg: patternSvg
            };
        }
        
        function lerpColor(a, b, amount) { 
            const ah = parseInt(a.replace(/#/g, ''), 16),
                  ar = ah >> 16, ag = ah >> 8 & 0xff, ab = ah & 0xff,
                  bh = parseInt(b.replace(/#/g, ''), 16),
                  br = bh >> 16, bg = bh >> 8 & 0xff, bb = bh & 0xff,
                  rr = ar + amount * (br - ar),
                  rg = ag + amount * (bg - ag),
                  rb = ab + amount * (bb - ab);
            return '#' + ((1 << 24) + (rr << 16) + (rg << 8) + rb | 0).toString(16).slice(1);
        }
        
        function generateCirclePattern(seed, primaryColor, secondaryColor) {
            const rng = seedRandom(seed);
            let svg = `<svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
                <rect width="100" height="100" fill="${primaryColor}" />`;
            
            for (let i = 0; i < 20; i++) {
                const x = rng() * 100;
                const y = rng() * 100;
                const r = 3 + rng() * 8;
                
                svg += `<circle cx="${x}" cy="${y}" r="${r}" fill="${secondaryColor}" opacity="${0.3 + rng() * 0.4}" />`;
            }
            
            svg += '</svg>';
            return svg;
        }
        
        function generateTrianglePattern(seed, primaryColor, secondaryColor) {
            const rng = seedRandom(seed);
            let svg = `<svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
                <rect width="100" height="100" fill="${primaryColor}" />`;
            
            for (let i = 0; i < 15; i++) {
                const x1 = rng() * 100;
                const y1 = rng() * 100;
                const x2 = x1 + (-10 + rng() * 20);
                const y2 = y1 + (-10 + rng() * 20);
                const x3 = x1 + (-10 + rng() * 20);
                const y3 = y1 + (-10 + rng() * 20);
                
                svg += `<polygon points="${x1},${y1} ${x2},${y2} ${x3},${y3}" fill="${secondaryColor}" opacity="${0.3 + rng() * 0.4}" />`;
            }
            
            svg += '</svg>';
            return svg;
        }
        
        function generateHexagonPattern(seed, primaryColor, secondaryColor) {
            const rng = seedRandom(seed);
            let svg = `<svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
                <rect width="100" height="100" fill="${primaryColor}" />`;
            
            for (let i = 0; i < 10; i++) {
                const cx = rng() * 100;
                const cy = rng() * 100;
                const r = 5 + rng() * 10;
                
                let points = '';
                for (let j = 0; j < 6; j++) {
                    const angle = j * (Math.PI / 3);
                    const x = cx + r * Math.cos(angle);
                    const y = cy + r * Math.sin(angle);
                    points += `${x},${y} `;
                }
                
                svg += `<polygon points="${points}" fill="${secondaryColor}" opacity="${0.3 + rng() * 0.4}" />`;
            }
            
            svg += '</svg>';
            return svg;
        }
        
        function generateStarPattern(seed, primaryColor, secondaryColor) {
            const rng = seedRandom(seed);
            let svg = `<svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
                <rect width="100" height="100" fill="${primaryColor}" />`;
            
            for (let i = 0; i < 8; i++) {
                const cx = rng() * 100;
                const cy = rng() * 100;
                const r1 = 3 + rng() * 5;
                const r2 = r1 * 2.5;
                
                let points = '';
                for (let j = 0; j < 10; j++) {
                    const angle = j * (Math.PI / 5);
                    const r = j % 2 === 0 ? r2 : r1;
                    const x = cx + r * Math.cos(angle);
                    const y = cy + r * Math.sin(angle);
                    points += `${x},${y} `;
                }
                
                svg += `<polygon points="${points}" fill="${secondaryColor}" opacity="${0.3 + rng() * 0.6}" />`;
            }
            
            svg += '</svg>';
            return svg;
        }
        
        function generateDiamondPattern(seed, primaryColor, secondaryColor) {
            const rng = seedRandom(seed);
            
            let svg = `<svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
                <defs>
                    <radialGradient id="glow" cx="50%" cy="50%" r="50%" fx="50%" fy="50%">
                        <stop offset="0%" stop-color="#ffffff" stop-opacity="0.8"/>
                        <stop offset="100%" stop-color="${primaryColor}" stop-opacity="0.2"/>
                    </radialGradient>
                </defs>
                <rect width="100" height="100" fill="${primaryColor}" />
                <rect width="100" height="100" fill="url(#glow)" />`;
            
            for (let i = 0; i < 12; i++) {
                const x = rng() * 100;
                const y = rng() * 100;
                const size = 5 + rng() * 10;
                
                svg += `
                    <rect x="${x - size/2}" y="${y - size/2}" width="${size}" height="${size}" 
                          transform="rotate(${rng() * 45}, ${x}, ${y})"
                          fill="${secondaryColor}" opacity="${0.4 + rng() * 0.6}" />`;
            }
            
            for (let i = 0; i < 20; i++) {
                const x = rng() * 100;
                const y = rng() * 100;
                const r = 0.5 + rng() * 1.5;
                
                svg += `<circle cx="${x}" cy="${y}" r="${r}" fill="white" opacity="${0.7 + rng() * 0.3}" />`;
            }
            
            svg += '</svg>';
            return svg;
        }
        
        function generateSpecialPattern(seed) {
            const rng = seedRandom(seed);
            
            let svg = `<svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
                <defs>
                    <linearGradient id="rainbow" x1="0%" y1="0%" x2="100%" y2="100%">
                        <stop offset="0%" stop-color="#ff4500" />
                        <stop offset="25%" stop-color="#ff9800" />
                        <stop offset="50%" stop-color="#ffeb3b" />
                        <stop offset="75%" stop-color="#2196f3" />
                        <stop offset="100%" stop-color="#9c27b0" />
                    </linearGradient>
                </defs>
                <rect width="100" height="100" fill="url(#rainbow)" />`;
            
            for (let i = 0; i < 6; i++) {
                const cx = 15 + i * 15;
                const cy = 50;
                const r = 10 + rng() * 5;
                
                svg += `<circle cx="${cx}" cy="${cy}" r="${r}" fill="none" stroke="white" stroke-width="1.5" opacity="0.7" />`;
            }
            
            for (let i = 0; i < 30; i++) {
                const x = rng() * 100;
                const y = rng() * 100;
                const r = 0.5 + rng() * 2;
                
                svg += `<circle cx="${x}" cy="${y}" r="${r}" fill="white" opacity="${0.4 + rng() * 0.6}" />`;
            }
            
            svg += '</svg>';
            return svg;
        }
        
        function seedRandom(seed) {
            return function() {
                const x = Math.sin(seed++) * 10000;
                return x - Math.floor(x);
            };
        }
        
        function showCard(card) {
            app.currentCard = card;
            
            const cardFront = elements.card.querySelector('.card-front');
            cardFront.innerHTML = `
                <div class="card-header">
                    <span class="card-name">${card.name}</span>
                    <span class="card-rarity ${card.rarity}">${card.rarity}</span>
                </div>
                <div class="card-image">
                    ${card.imageSvg}
                </div>
                <div class="card-stats">
                    <div class="card-value">
                        💎 ${card.value}
                    </div>
                    <div class="card-level">
                        Lvl ${card.level}
                    </div>
                </div>
            `;
            
            elements.card.className = `card ${card.rarity} rolling`;
            
            setTimeout(() => {
                showRollResultModal(card);
            }, 1500);
        }
        
        function showRollResultModal(card) {
            elements.rollResultContent.innerHTML = `
                <div style="display: flex; align-items: center; justify-content: center; margin-bottom: 20px;">
                    <div class="card ${card.rarity}" style="position: static; transform: none; cursor: default;">
                        <div class="card-face card-front" style="backface-visibility: visible; position: static; transform: none;">
                            <div class="card-header">
                                <span class="card-name">${card.name}</span>
                                <span class="card-rarity ${card.rarity}">${card.rarity}</span>
                            </div>
                            <div class="card-image">
                                ${card.imageSvg}
                            </div>
                            <div class="card-stats">
                                <div class="card-value">
                                    💎 ${card.value}
                                </div>
                                <div class="card-level">
                                    Lvl ${card.level}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <p style="text-align: center; font-size: 1.2rem; margin-bottom: 10px;">
                    You rolled a ${card.rarity} card!
                </p>
                <p style="text-align: center; opacity: 0.8;">
                    Would you like to keep this card in your inventory or sell it for ${card.value} 💎?
                </p>
            `;
            
            if (game.inventory.length >= game.inventoryLimit) {
                elements.rollResultContent.innerHTML += `
                    <p style="text-align: center; color: #f44336; margin-top: 10px;">
                        <strong>Warning:</strong> Your inventory is full! Selling old cards creates space.
                    </p>
                `;
            }
            
            elements.keepCardBtn.textContent = "Keep Card";
            elements.sellCardBtn.textContent = `Sell for ${card.value} 💎`;
            
            elements.rollResultModal.classList.add('active');
            
            if (card.rarity === 'rare' || card.rarity === 'epic' || card.rarity === 'legendary' || card.rarity === 'limited') {
                confetti.start();
            }
        }
        
        function keepCard(card) {
            if (game.inventory.length >= game.inventoryLimit) {
                showNotification('Inventory Full', 'Your inventory is full! Sell some cards first.', 'error');
                return false;
            }
            
            game.inventory.push(card);
            game.collection[card.rarity + 'Count']++;
            showNotification('Card Added', `${card.name} has been added to your inventory!`, 'success');
            addExperience(10);
            updateStats();
            saveGameData();
            return true;
        }
        
        function sellCard(card) {
            const sellValue = calculateSellValue(card);
            game.currency += sellValue;
            updateCurrencyDisplay();
            
            game.collection.cardsSold++;
            showNotification('Card Sold', `Sold ${card.name} for ${sellValue} 💎`, 'success');
            addExperience(3);
            updateStats();
            saveGameData();
            return true;
        }
        
        function calculateSellValue(card) {
            let value = card.value;
            
            if (game.powerUps.doubleCurrency > 0) {
                value *= 2;
            }
            
            return value;
        }
        
        function updateCurrencyDisplay() {
            elements.currencyValue.textContent = game.currency;
        }
        
        function updateStats() {
            elements.totalRolls.textContent = game.collection.totalRolls;
            elements.cardsCollected.textContent = game.inventory.length;
            elements.cardsSold.textContent = game.collection.cardsSold;
            elements.cardsCrafted.textContent = game.collection.cardsCrafted;
            elements.playerLevel.textContent = game.level;
            
            const totalValue = game.inventory.reduce((sum, card) => sum + card.value, 0);
            elements.totalValue.textContent = totalValue;
            
            elements.commonCount.textContent = game.collection.commonCount;
            elements.uncommonCount.textContent = game.collection.uncommonCount;
            elements.rareCount.textContent = game.collection.rareCount;
            elements.epicCount.textContent = game.collection.epicCount;
            elements.legendaryCount.textContent = game.collection.legendaryCount;
            elements.limitedCount.textContent = game.collection.limitedCount;
            
            const totalCards = game.collection.commonCount + 
                               game.collection.uncommonCount + 
                               game.collection.rareCount + 
                               game.collection.epicCount + 
                               game.collection.legendaryCount +
                               game.collection.limitedCount;
            
            const progressPercentage = Math.min(100, Math.floor((totalCards / 100) * 100));
            elements.progressFill.style.width = `${progressPercentage}%`;
            elements.progressLabel.textContent = `${progressPercentage}%`;
        }
        
        function updateUserProfile() {
            if (app.user) {
                const userName = app.user.email.split('@')[0];
                elements.userAvatar.textContent = userName.charAt(0).toUpperCase();
                elements.userName.textContent = userName;
                elements.userLevel.textContent = `Level ${game.level}`;
            }
        }
        
        function updateAllDisplays() {
            updateCurrencyDisplay();
            updateStats();
            updateUserProfile();
        }
        
        function updateInventoryDisplay() {
            elements.inventoryCount.textContent = `Cards: ${game.inventory.length}/${game.inventoryLimit}`;
            elements.inventoryGrid.innerHTML = '';
            
            if (game.inventory.length === 0) {
                elements.inventoryGrid.innerHTML = `
                    <div style="grid-column: 1 / -1; text-align: center; padding: 20px;">
                        <p>Your inventory is empty. Roll some cards!</p>
                    </div>
                `;
                return;
            }
            
            game.inventory.forEach((card, index) => {
                const cardElement = document.createElement('div');
                cardElement.className = `inventory-card ${card.rarity}`;
                cardElement.innerHTML = `
                    <div class="inventory-card-image">
                        ${card.imageSvg}
                    </div>
                    <div class="inventory-card-info">
                        <div class="inventory-card-name">${card.name}</div>
                        <div class="inventory-card-rarity ${card.rarity}">${card.rarity}</div>
                        <div class="inventory-card-value">💎 ${card.value}</div>
                    </div>
                    <div class="inventory-actions">
                        <button class="inventory-action-btn sell-btn" data-index="${index}" title="Sell Card">
                            💰
                        </button>
                        <button class="inventory-action-btn craft-select-btn" data-index="${index}" title="Craft Card">
                            ✨
                        </button>
                    </div>
                `;
                elements.inventoryGrid.appendChild(cardElement);
                
                cardElement.querySelector('.sell-btn').addEventListener('click', (e) => {
                    e.stopPropagation();
                    const index = parseInt(e.target.dataset.index);
                    const cardToSell = game.inventory[index];
                    game.inventory.splice(index, 1);
                    sellCard(cardToSell);
                    updateInventoryDisplay();
                });
                
                cardElement.querySelector('.craft-select-btn').addEventListener('click', (e) => {
                    e.stopPropagation();
                    openCraftWithSelectedTab('select');
                    const card = game.inventory[parseInt(e.target.dataset.index)];
                    selectRecipeForRarity(card.rarity);
                    closeModal(elements.inventoryModal);
                });
            });
        }
        
        function selectRecipeForRarity(rarity) {
            let recipeId = null;
            
            switch(rarity) {
                case 'common':
                    recipeId = 'common-to-uncommon';
                    break;
                case 'uncommon':
                    recipeId = 'uncommon-to-rare';
                    break;
                case 'rare':
                    recipeId = 'rare-to-epic';
                    break;
                case 'epic':
                    recipeId = 'epic-to-legendary';
                    break;
                case 'legendary':
                    recipeId = 'mixed-limited';
                    break;
                default:
                    recipeId = 'common-to-uncommon';
            }
            
            const recipeCard = document.querySelector(`.craft-recipe-card[data-recipe="${recipeId}"]`);
            if (recipeCard) {
                selectCraftingRecipe(recipeId);
                document.querySelectorAll('.craft-recipe-card').forEach(card => {
                    card.classList.remove('selected');
                });
                recipeCard.classList.add('selected');
            }
        }
        
        function updateMarketDisplay(category = 'powerups') {
            const items = game.marketItems[category];
            elements.marketItems.innerHTML = '';
            
            items.forEach(item => {
                const itemElement = document.createElement('div');
                itemElement.className = 'market-item';
                itemElement.innerHTML = `
                    <div class="market-item-image">${item.icon}</div>
                    <div class="market-item-title">${item.name}</div>
                    <div class="market-item-description">${item.description}</div>
                    <div class="market-item-price">
                        ${item.realPrice ? item.realPrice : `💎 ${item.price}`}
                    </div>
                `;
                
                itemElement.addEventListener('click', () => {
                    if (item.realPrice) {
                        item.effect();
                    } else {
                        if (game.currency >= item.price) {
                            game.currency -= item.price;
                            updateCurrencyDisplay();
                            item.effect();
                            saveGameData();
                        } else {
                            showNotification('Not Enough Currency', `You need ${item.price} 💎 to purchase this item`, 'error');
                        }
                    }
                });
                
                elements.marketItems.appendChild(itemElement);
            });
        }
        
        function openCraftWithSelectedTab(tabId) {
            openModal(elements.craftModal);
            
            elements.craftTabs.forEach(tab => {
                tab.classList.remove('active');
                if (tab.dataset.tab === tabId) {
                    tab.classList.add('active');
                }
            });
            
            elements.craftContents.forEach(content => {
                content.classList.remove('active');
                if (content.id === tabId + '-tab') {
                    content.classList.add('active');
                }
            });
            
            game.crafting.currentTab = tabId;
            updateCraftButtons();
            refreshCraftingUI();
        }
        
        function selectCraftingRecipe(recipeId) {
            const recipe = game.craftingRecipes[recipeId];
            if (!recipe) return;
            
            game.crafting.selectedRecipe = recipeId;
            game.crafting.selectedCards = [];
            refreshCraftingUI();
        }
        
        function refreshCraftingUI() {
            const tab = game.crafting.currentTab;
            
            if (game.crafting.selectedRecipe) {
                const recipe = game.craftingRecipes[game.crafting.selectedRecipe];
                elements.selectedRecipeName.textContent = recipe.name;
                
                if (recipe.input.mixed) {
                    elements.recipeRequirements.textContent = 
                        `This recipe requires one card of each rarity: ${recipe.input.mixed.join(', ')}.`;
                } else {
                    elements.recipeRequirements.textContent = 
                        `This recipe requires ${recipe.input.count} ${recipe.input.rarity} cards.`;
                }
                
                const requiredCount = recipe.input.mixed ? recipe.input.mixed.length : recipe.input.count;
                elements.requiredCount.textContent = requiredCount;
                elements.selectedCount.textContent = game.crafting.selectedCards.length;
                
                elements.selectionInstruction.textContent = recipe.input.mixed
                    ? 'Select one card of each rarity to create a Limited Edition card.'
                    : `Select ${recipe.input.count} ${recipe.input.rarity} cards to create a ${recipe.output.rarity} card.`;
            }
            
            if (tab === 'select' && game.crafting.selectedRecipe) {
                updateCraftInventoryDisplay();
                updateCraftSelectionDisplay();
            }
            
            if (tab === 'preview') {
                updateCraftPreview();
            }
            
            document.querySelectorAll('.craft-recipe-card').forEach(card => {
                card.classList.toggle('selected', card.dataset.recipe === game.crafting.selectedRecipe);
            });
            
            updateCraftButtons();
        }
        
        function updateCraftInventoryDisplay() {
            elements.craftInventoryGrid.innerHTML = '';
            
            if (game.inventory.length === 0) {
                elements.craftInventoryGrid.innerHTML = `
                    <div style="grid-column: 1 / -1; text-align: center; padding: 20px;">
                        <p>Your inventory is empty. Roll some cards first!</p>
                    </div>
                `;
                return;
            }
            
            const recipe = game.craftingRecipes[game.crafting.selectedRecipe];
            let filteredCards = game.inventory;
            
            if (recipe) {
                if (recipe.input.mixed) {
                    const selectedRarities = game.crafting.selectedCards.map(sc => game.inventory[sc].rarity);
                    filteredCards = game.inventory.filter(card => 
                        recipe.input.mixed.includes(card.rarity) && !selectedRarities.includes(card.rarity)
                    );
                } else {
                    filteredCards = game.inventory.filter(card => card.rarity === recipe.input.rarity);
                }
            }
            
            filteredCards.forEach((card, index) => {
                const inInventoryIndex = game.inventory.indexOf(card);
                const isSelected = game.crafting.selectedCards.includes(inInventoryIndex);
                
                const cardElement = document.createElement('div');
                cardElement.className = `inventory-card craft-card-item ${card.rarity} ${isSelected ? 'selected' : ''}`;
                cardElement.dataset.index = inInventoryIndex;
                cardElement.innerHTML = `
                    <div class="inventory-card-image">
                        ${card.imageSvg}
                    </div>
                    <div class="inventory-card-info">
                        <div class="inventory-card-name">${card.name}</div>
                        <div class="inventory-card-rarity ${card.rarity}">${card.rarity}</div>
                        <div class="inventory-card-value">💎 ${card.value}</div>
                    </div>
                `;
                
                cardElement.addEventListener('click', () => {
                    toggleCardSelection(inInventoryIndex);
                });
                
                elements.craftInventoryGrid.appendChild(cardElement);
            });
        }
        
        function toggleCardSelection(cardIndex) {
            const recipe = game.craftingRecipes[game.crafting.selectedRecipe];
            if (!recipe) return;
            
            const isSelected = game.crafting.selectedCards.includes(cardIndex);
            const card = game.inventory[cardIndex];
            
            if (isSelected) {
                game.crafting.selectedCards = game.crafting.selectedCards.filter(idx => idx !== cardIndex);
            } else {
                const maxCards = recipe.input.mixed ? recipe.input.mixed.length : recipe.input.count;
                
                if (game.crafting.selectedCards.length >= maxCards) {
                    showNotification('Selection Full', `You can only select ${maxCards} cards for this recipe`, 'warning');
                    return;
                }
                
                if (recipe.input.mixed) {
                    const selectedCards = game.crafting.selectedCards.map(idx => game.inventory[idx]);
                    const hasRarity = selectedCards.some(c => c.rarity === card.rarity);
                    
                    if (hasRarity) {
                        showNotification('Duplicate Rarity', `You already selected a ${card.rarity} card`, 'warning');
                        return;
                    }
                }
                
                game.crafting.selectedCards.push(cardIndex);
            }
            
            refreshCraftingUI();
        }
        
        function updateCraftSelectionDisplay() {
            elements.craftSelectionDisplay.innerHTML = '';
            
            if (game.crafting.selectedCards.length === 0) {
                elements.craftSelectionDisplay.innerHTML = `<p>No cards selected yet.</p>`;
                return;
            }
            
            game.crafting.selectedCards.forEach((cardIndex, selectionIndex) => {
                const card = game.inventory[cardIndex];
                
                const cardElement = document.createElement('div');
                cardElement.className = `craft-selection-card ${card.rarity}`;
                cardElement.innerHTML = `
                    ${card.imageSvg}
                    <div class="craft-selection-remove" data-index="${selectionIndex}">×</div>
                `;
                
                elements.craftSelectionDisplay.appendChild(cardElement);
                
                cardElement.querySelector('.craft-selection-remove').addEventListener('click', (e) => {
                    const idx = parseInt(e.target.dataset.index);
                    game.crafting.selectedCards.splice(idx, 1);
                    refreshCraftingUI();
                });
            });
        }
        
        function updateCraftPreview() {
            const recipe = game.craftingRecipes[game.crafting.selectedRecipe];
            if (!recipe || game.crafting.selectedCards.length === 0) {
                elements.craftInputCards.innerHTML = `<p>No cards selected</p>`;
                elements.craftResultPreview.innerHTML = `<div id="craft-result-placeholder">?</div>`;
                elements.craftResultPreview.classList.remove('has-card');
                return;
            }
            
            elements.craftInputCards.innerHTML = '';
            
            game.crafting.selectedCards.forEach(cardIndex => {
                const card = game.inventory[cardIndex];
                
                const cardElement = document.createElement('div');
                cardElement.className = `craft-selection-card ${card.rarity}`;
                cardElement.innerHTML = card.imageSvg;
                
                elements.craftInputCards.appendChild(cardElement);
            });
            
            const requiredCount = recipe.input.mixed ? recipe.input.mixed.length : recipe.input.count;
            
            if (game.crafting.selectedCards.length === requiredCount) {
                game.crafting.previewCard = createCard(recipe.output.rarity);
                
                elements.craftResultPreview.innerHTML = game.crafting.previewCard.imageSvg;
                elements.craftResultPreview.classList.add('has-card');
                
                elements.executeCraftBtn.disabled = false;
            } else {
                elements.craftResultPreview.innerHTML = `<div id="craft-result-placeholder">?</div>`;
                elements.craftResultPreview.classList.remove('has-card');
                elements.executeCraftBtn.disabled = true;
            }
        }
        
        function executeCrafting() {
            const recipe = game.craftingRecipes[game.crafting.selectedRecipe];
            if (!recipe || game.crafting.selectedCards.length === 0) {
                showNotification('Crafting Failed', 'Please select a recipe and cards first', 'error');
                return;
            }
            
            const requiredCount = recipe.input.mixed ? recipe.input.mixed.length : recipe.input.count;
            
            if (game.crafting.selectedCards.length < requiredCount) {
                showNotification('Crafting Failed', `You need ${requiredCount} cards for this recipe`, 'error');
                return;
            }
            
            const sortedIndices = [...game.crafting.selectedCards].sort((a, b) => b - a);
            const resultCard = game.crafting.previewCard || createCard(recipe.output.rarity);
            
            sortedIndices.forEach(index => {
                game.inventory.splice(index, 1);
            });
            
            game.inventory.push(resultCard);
            
            game.collection.cardsCrafted++;
            game.collection[resultCard.rarity + 'Count']++;
            
            showNotification('Crafting Success', `Created a new ${resultCard.rarity} card: ${resultCard.name}!`, 'success');
            
            addExperience(30);
            
            game.crafting.selectedCards = [];
            game.crafting.previewCard = null;
            
            confetti.start();
            
            closeModal(elements.craftModal);
            
            updateInventoryDisplay();
            updateStats();
            saveGameData();
        }
        
        function updateCraftButtons() {
            const tab = game.crafting.currentTab;
            
            elements.craftBackBtn.style.display = tab === 'recipe' ? 'none' : 'block';
            elements.craftNextBtn.style.display = tab === 'preview' ? 'none' : 'block';
            elements.executeCraftBtn.style.display = tab === 'preview' ? 'block' : 'none';
            
            if (tab === 'recipe') {
                elements.craftNextBtn.disabled = !game.crafting.selectedRecipe;
            }
            
            if (tab === 'select') {
                const recipe = game.craftingRecipes[game.crafting.selectedRecipe];
                const requiredCount = recipe?.input.mixed ? recipe.input.mixed.length : (recipe?.input.count || 0);
                elements.craftNextBtn.disabled = game.crafting.selectedCards.length === 0;
            }
            
            if (tab === 'preview') {
                const recipe = game.craftingRecipes[game.crafting.selectedRecipe];
                const requiredCount = recipe?.input.mixed ? recipe.input.mixed.length : (recipe?.input.count || 0);
                elements.executeCraftBtn.disabled = game.crafting.selectedCards.length < requiredCount;
            }
        }
        
        function nextCraftingTab() {
            const currentTab = game.crafting.currentTab;
            let nextTab;
            
            if (currentTab === 'recipe') {
                nextTab = 'select';
            } else if (currentTab === 'select') {
                nextTab = 'preview';
            }
            
            if (nextTab) {
                openCraftWithSelectedTab(nextTab);
            }
        }
        
        function previousCraftingTab() {
            const currentTab = game.crafting.currentTab;
            let prevTab;
            
            if (currentTab === 'select') {
                prevTab = 'recipe';
            } else if (currentTab === 'preview') {
                prevTab = 'select';
            }
            
            if (prevTab) {
                openCraftWithSelectedTab(prevTab);
            }
        }
        
        function sortInventory() {
            const rarityOrder = {
                'common': 0,
                'uncommon': 1,
                'rare': 2,
                'epic': 3,
                'legendary': 4,
                'limited': 5
            };
            
            game.inventory.sort((a, b) => {
                return rarityOrder[b.rarity] - rarityOrder[a.rarity];
            });
            
            updateInventoryDisplay();
            showNotification('Inventory Sorted', 'Your inventory has been sorted by rarity', 'success');
            saveGameData();
        }
        
        function updateProfileDisplay() {
            if (!app.user) return;
            
            const totalValue = game.inventory.reduce((sum, card) => sum + card.value, 0);
            const accountAge = Math.floor((Date.now() - new Date(app.user.created_at).getTime()) / (1000 * 60 * 60 * 24));
            
            elements.profileContent.innerHTML = `
                <div style="text-align: center; margin-bottom: 30px;">
                    <div class="user-avatar" style="width: 80px; height: 80px; font-size: 2rem; margin: 0 auto 15px;">${app.user.email.charAt(0).toUpperCase()}</div>
                    <h3>${app.user.email.split('@')[0]}</h3>
                    <p>Level ${game.level} • ${accountAge} days old</p>
                </div>
                
                <div class="stats-grid">
                    <div class="stat-card">
                        <span class="stat-value">${game.collection.totalRolls}</span>
                        <span class="stat-label">Total Rolls</span>
                    </div>
                    <div class="stat-card">
                        <span class="stat-value">${game.inventory.length}</span>
                        <span class="stat-label">Cards Owned</span>
                    </div>
                    <div class="stat-card">
                        <span class="stat-value">${totalValue}</span>
                        <span class="stat-label">Collection Value</span>
                    </div>
                    <div class="stat-card">
                        <span class="stat-value">${game.collection.cardsCrafted}</span>
                        <span class="stat-label">Cards Crafted</span>
                    </div>
                    <div class="stat-card">
                        <span class="stat-value">${game.currency}</span>
                        <span class="stat-label">Current Gems</span>
                    </div>
                    <div class="stat-card">
                        <span class="stat-value">${Math.floor((game.experience / game.experienceToNext) * 100)}%</span>
                        <span class="stat-label">Level Progress</span>
                    </div>
                </div>
                
                <h3 class="stats-title">Achievements</h3>
                <div style="display: grid; gap: 10px;">
                    ${game.collection.totalRolls >= 100 ? '<div style="padding: 10px; background: rgba(76, 175, 80, 0.1); border-radius: 10px;">🎲 Century Roller - Roll 100 cards</div>' : ''}
                    ${game.collection.legendaryCount >= 1 ? '<div style="padding: 10px; background: rgba(255, 193, 7, 0.1); border-radius: 10px;">🌟 Legendary Collector - Own a legendary card</div>' : ''}
                    ${game.level >= 10 ? '<div style="padding: 10px; background: rgba(93, 92, 222, 0.1); border-radius: 10px;">📈 Level Master - Reach level 10</div>' : ''}
                    ${game.collection.cardsCrafted >= 10 ? '<div style="padding: 10px; background: rgba(156, 39, 176, 0.1); border-radius: 10px;">🔨 Master Crafter - Craft 10 cards</div>' : ''}
                </div>
            `;
        }
        
        function exportPlayerData() {
            if (!app.user) return;
            
            const exportData = {
                user_email: app.user.email,
                export_date: new Date().toISOString(),
                game_data: {
                    currency: game.currency,
                    level: game.level,
                    experience: game.experience,
                    inventory: game.inventory,
                    collection: game.collection,
                    power_ups: game.powerUps,
                    rarity_chances: game.rarityChances
                }
            };
            
            const dataStr = JSON.stringify(exportData, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            
            const link = document.createElement('a');
            link.href = url;
            link.download = `card_collector_data_${Date.now()}.json`;
            link.click();
            
            URL.revokeObjectURL(url);
            showNotification('Data Exported', 'Your game data has been downloaded', 'success');
        }
        
        function shareProfile() {
            if (!app.user) return;
            
            const shareText = `Check out my Card Collector Pro profile!\n\nLevel: ${game.level}\nCards Collected: ${game.inventory.length}\nTotal Rolls: ${game.collection.totalRolls}\nLegendary Cards: ${game.collection.legendaryCount}\n\nPlay Card Collector Pro now!`;
            
            if (navigator.share) {
                navigator.share({
                    title: 'Card Collector Pro Profile',
                    text: shareText
                });
            } else if (navigator.clipboard) {
                navigator.clipboard.writeText(shareText).then(() => {
                    showNotification('Profile Copied', 'Your profile text has been copied to clipboard', 'success');
                });
            } else {
                showNotification('Share Not Available', 'Sharing is not available on this device', 'warning');
            }
        }
        
        function showNotification(title, message, type = 'info') {
            const notification = elements.notification;
            
            notification.className = 'notification';
            notification.classList.add(type);
            
            notification.querySelector('.notification-title').textContent = title;
            notification.querySelector('.notification-message').innerHTML = message;
            
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }
        
        function openModal(modal) {
            modal.classList.add('active');
        }
        
        function closeModal(modal) {
            modal.classList.remove('active');
        }
        
        // INITIALIZE APPLICATION
        async function initApp() {
            confetti.init();
            
            // Check for dark mode preference
            if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                document.documentElement.classList.add('dark');
            }
            
            window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
                if (event.matches) {
                    document.documentElement.classList.add('dark');
                } else {
                    document.documentElement.classList.remove('dark');
                }
            });
            
            // Listen for auth state changes
            supabase.auth.onAuthStateChange(async (event, session) => {
                if (event === 'SIGNED_IN') {
                    app.user = session.user;
                    elements.authScreen.classList.add('hidden');
                    elements.gameContainer.style.display = 'block';
                    
                    const loadedGame = await loadGameData();
                    if (!loadedGame) {
                        game.currency = 1000;
                        showNotification('Welcome!', 'Welcome to Card Collector Pro! You have 1000 💎 to start rolling cards.', 'success');
                    }
                    
                    updateAllDisplays();
                } else if (event === 'SIGNED_OUT') {
                    app.user = null;
                    elements.authScreen.classList.remove('hidden');
                    elements.gameContainer.style.display = 'none';
                    
                    // Reset game state
                    game.currency = 1000;
                    game.inventory = [];
                    game.level = 1;
                    game.experience = 0;
                    game.collection = {
                        totalRolls: 0,
                        cardsSold: 0,
                        cardsCrafted: 0,
                        commonCount: 0,
                        uncommonCount: 0,
                        rareCount: 0,
                        epicCount: 0,
                        legendaryCount: 0,
                        limitedCount: 0
                    };
                }
                
                elements.loadingScreen.classList.add('hidden');
                app.isLoading = false;
            });
            
            setupEventListeners();
            
            // Check initial auth state
            const { data: { session } } = await supabase.auth.getSession();
            if (!session) {
                elements.loadingScreen.classList.add('hidden');
                elements.authScreen.classList.remove('hidden');
            }
        }
        
        function setupEventListeners() {
            // Auth form
            elements.authForm.addEventListener('submit', (e) => {
                e.preventDefault();
                handleAuth(app.isSignUp);
            });
            
            elements.authToggle.addEventListener('click', toggleAuthMode);
            
            // Game buttons
            elements.rollButton.addEventListener('click', () => {
                const card = rollCard();
                if (card) {
                    showCard(card);
                }
            });
            
            elements.keepCardBtn.addEventListener('click', () => {
                if (app.currentCard) {
                    if (keepCard(app.currentCard)) {
                        closeModal(elements.rollResultModal);
                        app.currentCard = null;
                    }
                }
            });
            
            elements.sellCardBtn.addEventListener('click', () => {
                if (app.currentCard) {
                    sellCard(app.currentCard);
                    closeModal(elements.rollResultModal);
                    app.currentCard = null;
                }
            });
            
            // Navigation buttons
            elements.openInventoryBtn.addEventListener('click', () => {
                updateInventoryDisplay();
                openModal(elements.inventoryModal);
            });
            
            elements.openMarketBtn.addEventListener('click', () => {
                updateMarketDisplay();
                openModal(elements.marketModal);
            });
            
            elements.openCraftBtn.addEventListener('click', () => {
                game.crafting = {
                    currentTab: 'recipe',
                    selectedRecipe: null,
                    selectedCards: [],
                    previewCard: null
                };
                openCraftWithSelectedTab('recipe');
            });
            
            elements.openProfileBtn.addEventListener('click', () => {
                updateProfileDisplay();
                openModal(elements.profileModal);
            });
            
            elements.logoutBtn.addEventListener('click', signOut);
            
            // Craft tab navigation
            elements.craftTabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    openCraftWithSelectedTab(tab.dataset.tab);
                });
            });
            
            // Craft recipe selection
            elements.recipeCards.forEach(recipeCard => {
                recipeCard.addEventListener('click', () => {
                    selectCraftingRecipe(recipeCard.dataset.recipe);
                    
                    elements.recipeCards.forEach(card => {
                        card.classList.remove('selected');
                    });
                    recipeCard.classList.add('selected');
                });
            });
            
            // Craft navigation buttons
            elements.craftBackBtn.addEventListener('click', previousCraftingTab);
            elements.craftNextBtn.addEventListener('click', nextCraftingTab);
            elements.executeCraftBtn.addEventListener('click', executeCrafting);
            
            // Inventory actions
            elements.sellAllBtn.addEventListener('click', () => {
                if (game.inventory.length === 0) {
                    showNotification('Inventory Empty', 'You have no cards to sell', 'warning');
                    return;
                }
                
                let totalValue = 0;
                game.inventory.forEach(card => {
                    totalValue += calculateSellValue(card);
                });
                
                game.currency += totalValue;
                game.collection.cardsSold += game.inventory.length;
                game.inventory = [];
                
                updateCurrencyDisplay();
                updateInventoryDisplay();
                updateStats();
                saveGameData();
                
                showNotification('All Cards Sold', `Sold all cards for ${totalValue} 💎`, 'success');
            });
            
            elements.sortInventoryBtn.addEventListener('click', sortInventory);
            
            // Profile actions
            elements.exportDataBtn.addEventListener('click', exportPlayerData);
            elements.shareProfileBtn.addEventListener('click', shareProfile);
            
            // Theme toggle
            elements.themeToggleBtn.addEventListener('click', () => {
                document.documentElement.classList.toggle('dark');
            });
            
            // Close modal buttons
            elements.closeRollModal.addEventListener('click', () => closeModal(elements.rollResultModal));
            elements.closeInventoryModal.addEventListener('click', () => closeModal(elements.inventoryModal));
            elements.closeCraftModal.addEventListener('click', () => closeModal(elements.craftModal));
            elements.closeMarketModal.addEventListener('click', () => closeModal(elements.marketModal));
            elements.closeProfileModal.addEventListener('click', () => closeModal(elements.profileModal));
            
            // Market category listeners
            document.querySelectorAll('.market-category').forEach(category => {
                category.addEventListener('click', () => {
                    document.querySelectorAll('.market-category').forEach(c => c.classList.remove('active'));
                    category.classList.add('active');
                    updateMarketDisplay(category.dataset.category);
                });
            });
        }
        
        // Start the application when DOM is loaded
        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>
